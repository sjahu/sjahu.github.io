<!doctype html>
<html lang="en">

<head>
  <title>Smartening up my dumb vacuum | Stephen's Site</title>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="/assets/css/style.css">
  <link rel="alternate" type="application/rss+xml" title="RSS" href="/blog/feed.xml">
</head>

<body>
  <div id="default-container">
    <div id="default-header">
      
      <nav>
        <a href="/">Home</a>
        <a href="/blog">Blog</a>
      </nav>
      
    </div>

    <div id="default-content">
      <h1 class="post-title">Smartening up my dumb vacuum</h1>
<div class="post-publish-date">Published Tuesday, October 04, 2022</div>

<figure class="post-header-image">
  <img src="/assets/images/blog/2022-10-04/eyes.jpg">
  
  <figcaption>üëÄ</figcaption>
  
</figure>

<section class="post-content">
  <p>For the last couple years, I‚Äôve had a habit of vacuuming my apartment Thursday afternoons while listening to a weekly live-streamed all-hands meeting for work. Mid summer, this meeting was rescheduled to a monthly cadence, so, with my dedicated vacuuming time gone and my floor getting dusty, I bought a robot vacuum.</p>

<p>The same week, iRobot, maker of the Roomba line of robotic vacuums, was <a href="https://www.cnn.com/2022/08/05/tech/amazon-irobot-roomba/index.html">in the news</a> after announcing a deal to sell out to Amazon. I‚Äôm not interested in handing Amazon a map of my apartment, so that took any of iRobot‚Äôs Wi-Fi-enabled vacuums (which is all of them) off the table. Amazon acquisition aside, I‚Äôm not a fan of Wi-Fi-enabled appliances anyway because I don‚Äôt trust them to a) be secure, b) respect my privacy, c) work well, or d) function at all after the manufacturer inevitably drops support for them a few years down the line. All of these ‚Äúfeatures‚Äù usually come at a premium, too!</p>

<p>So, I bought an <a href="https://www.amazon.ca/Eufy-BoostIQ-Super-Thin-Self-Charging-Medium-Pile/dp/B079QYYGF1">Anker Eufy RoboVac 11S</a> (from Amazon üôà) for a cool $169.99. The 11S is basically a sleeker-looking clone of the <a href="https://commons.wikimedia.org/wiki/File:Roomba_original.jpg">original Roomba from 2002</a>; it has almost the exact same feature set, minus support for ‚Äúvirtual walls‚Äù, which are infrared beacons that let you restrict the Roomba from passing through certain doorways. Critically, like the 2002 Roomba, the 11S has no Wi-Fi‚Äì it‚Äôs controlled using an infrared remote to select between cleaning modes and schedule cleaning sessions in advance. I figured this would meet my needs perfectly: random-pattern Wi-Fi-less cleaning on a schedule; all I‚Äôd have to do was empty the dustbin.</p>

<p><img src="/assets/images/blog/2022-10-04/phoebe_meets_robovac.jpg" class="small" /></p>

<p>As it turned out, the remote‚Äôs scheduling feature could only schedule cleanings up to 24 hours in advance; not ‚Äúevery afternoon at hh:mm‚Äù or ‚Äúevery second day at hh:mm‚Äù, just ‚Äúthe next time it‚Äôs hh:mm‚Äù, which, in my opinion, is little better than just manually starting the vacuum. I quickly got tired of doing either and set out to automate the automatic vacuum.</p>

<h2 id="plan-of-attack">Plan of Attack</h2>

<ol>
  <li>Record the remote‚Äôs infrared signals.</li>
  <li>Program an <a href="https://www.aliexpress.com/wholesale?SearchText=esp32">ESP32 Wi-Fi microcontroller</a> to transmit appropriate remote signals when triggered by HomeKit (Apple‚Äôs iOS-integrated smart home system).</li>
  <li>Implant the chip into the vacuum.</li>
  <li>Control the vacuum from my phone and use HomeKit automations to schedule vacuuming.</li>
</ol>

<p>Let‚Äôs get to it.</p>

<h2 id="recording-infrared-signals">Recording Infrared Signals</h2>

<p>Like the infrared remote controls for most consumer electronics, the Eufy remote emits signals consisting of sequences of bits encoded as timed pulses of 940 nm light modulated at 38 kHZ, to distinguish the signal from environmental interference, e.g. from sunlight. Recording the signals was straightforward: I plugged a 38 kHz IR demodulator into an ESP32 development board, uploaded an IR receiving <a href="https://github.com/Arduino-IRremote/Arduino-IRremote/blob/master/examples/SimpleReceiver/SimpleReceiver.ino">demo sketch</a> from the <a href="https://github.com/Arduino-IRremote/Arduino-IRremote"><code class="language-plaintext highlighter-rouge">Arduino-IRremote</code></a> Arduino library (the ESP32 is Arduino-compatible), and blasted away, logging the codes output in the Arduino IDE‚Äôs serial monitor for each signal received from the remote.</p>

<p><img src="/assets/images/blog/2022-10-04/ir_demodulator_esp32.jpg" class="medium" /></p>

<p>The output from <code class="language-plaintext highlighter-rouge">Arduino-IRremote</code>‚Äôs receiver demo looks like this:</p>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-line-table"><tbody><tr id="line-1" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>1</pre></td><td class="rouge-code"><pre><span class="kt">uint32_t</span> <span class="n">tRawData</span><span class="p">[]</span><span class="o">=</span><span class="p">{</span><span class="mh">0x7D16</span><span class="p">,</span> <span class="mh">0xA4FF</span><span class="p">};</span>
</pre></td></tr><tr id="line-2" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>2</pre></td><td class="rouge-code"><pre><span class="n">IrSender</span><span class="p">.</span><span class="n">sendPulseDistanceWidthFromArray</span><span class="p">(</span><span class="mi">38</span><span class="p">,</span> <span class="mi">3050</span><span class="p">,</span> <span class="mi">2950</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">1500</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">tRawData</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">48</span><span class="p">,</span> <span class="n">PROTOCOL_IS_LSB_FIRST</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">millisofRepeatPeriod</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">numberOfRepeats</span><span class="o">&gt;</span><span class="p">);</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>Each received transmission is encoded as an array of 32-bit segments, where, if the signal were to be replayed, the segments would be transmitted in order, each one sent bit-by-bit with the least significant bit first. The second line of output demonstrates how to play back a signal, it includes all the parameters that characterize the transmission:</p>

<h3 id="signal-parameters">Signal parameters</h3>

<div class="language-text highlighter-rouge"><div class="highlight"><pre class="highlight"><code>Frequency:    38 kHz
Header mark:  3050 Œºs
Header space: 2950 Œºs
One mark:     550 Œºs
One space:    1500 Œºs
Zero mark:    550 Œºs
Zero space:   500 Œºs
Length:       48 bits
LSB/MSB:      LSB first
</code></pre></div></div>

<p>I converted the 32-bit segmented output for all the commands I recorded to a bitwise representation for easier analysis:</p>

<figure class="highlight"><pre><code class="language-python" data-lang="python"><table class="rouge-line-table"><tbody><tr id="line-1" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>1</pre></td><td class="rouge-code"><pre><span class="k">def</span> <span class="nf">ir_data_to_bit_string</span><span class="p">(</span><span class="n">data_array</span><span class="p">,</span> <span class="n">n_bits</span><span class="p">,</span> <span class="n">lsb_first</span> <span class="o">=</span> <span class="bp">True</span><span class="p">):</span>
</pre></td></tr><tr id="line-2" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>2</pre></td><td class="rouge-code"><pre>  <span class="nb">str</span> <span class="o">=</span> <span class="s">""</span>
</pre></td></tr><tr id="line-3" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>3</pre></td><td class="rouge-code"><pre>  <span class="k">for</span> <span class="n">segment</span> <span class="ow">in</span> <span class="n">data_array</span><span class="p">:</span>
</pre></td></tr><tr id="line-4" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>4</pre></td><td class="rouge-code"><pre>    <span class="n">segment_bits</span> <span class="o">=</span> <span class="s">"{:0{width}b}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">segment</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="p">(</span><span class="mi">32</span> <span class="k">if</span> <span class="n">n_bits</span> <span class="o">&gt;</span> <span class="mi">32</span> <span class="k">else</span> <span class="n">n_bits</span><span class="p">))</span>
</pre></td></tr><tr id="line-5" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>5</pre></td><td class="rouge-code"><pre>    <span class="k">if</span> <span class="n">lsb_first</span><span class="p">:</span>
</pre></td></tr><tr id="line-6" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>6</pre></td><td class="rouge-code"><pre>      <span class="n">segment_bits</span> <span class="o">=</span> <span class="n">segment_bits</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre></td></tr><tr id="line-7" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>7</pre></td><td class="rouge-code"><pre>    <span class="nb">str</span> <span class="o">=</span> <span class="nb">str</span> <span class="o">+</span> <span class="n">segment_bits</span>
</pre></td></tr><tr id="line-8" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>8</pre></td><td class="rouge-code"><pre>    <span class="n">n_bits</span> <span class="o">=</span> <span class="n">n_bits</span> <span class="o">-</span> <span class="mi">32</span>
</pre></td></tr><tr id="line-9" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>9</pre></td><td class="rouge-code"><pre>  <span class="k">return</span> <span class="nb">str</span>
</pre></td></tr></tbody></table></code></pre></figure>

<p>After some staring and squinting, I derived the following specification for the signals generated by the remote:</p>

<h3 id="signal-specification">Signal specification</h3>

<div style="max-width: 100%; overflow-x: auto;"><pre style="white-space: pre;"><code>
                                                                              Protocol identifier
                                                                             /        Command
                                                                            /        /    Unused
                                                                           /        /    /  Fan mode
                                                                          /        /    /  /  Clock hours
                                                                         /        /    /  /  /        Clock minutes
                                                                        /        /    /  /  /        /        Scheduled cleaning time
                                                                       /        /    /  /  /        /        /        Checksum
                                                                      /        /    /  /  /        /        /        /
Command          Clock     Fan mode  Schedule  Data                  0        8    12 14 16       24       32       40

Change fan mode  12:00 am  Standard  ---       {0x7816, 0xA1FF}      01101000 0001 11 10 00000000 00000000 11111111 10000101
Change fan mode  12:00 am  BoostIQ   ---       {0xB816, 0x21FF}      01101000 0001 11 01 00000000 00000000 11111111 10000100
Change fan mode  12:00 am  Max       ---       {0x3816, 0xC1FF}      01101000 0001 11 00 00000000 00000000 11111111 10000011

Set time         12:00 am  Standard  ---       {0x7D16, 0xA4FF}      01101000 1011 11 10 00000000 00000000 11111111 00100101
Set time         12:01 am  Standard  ---       {0x80007D16, 0x64FF}  01101000 1011 11 10 00000000 00000001 11111111 00100110
Set time         12:02 am  Standard  ---       {0xC0007D16, 0x14FF}  01101000 1011 11 10 00000000 00000010 11111111 00101000
Set time         12:03 am  Standard  ---       {0x20007D16, 0x94FF}  01101000 1011 11 10 00000000 00000011 11111111 00101001
Set time         01:00 am  Standard  ---       {0x807D16, 0x64FF}    01101000 1011 11 10 00000001 00000000 11111111 00100110
Set time         01:01 am  Standard  ---       {0x80807D16, 0xE4FF}  01101000 1011 11 10 00000001 00000001 11111111 00100111
Set time         02:00 am  Standard  ---       {0x407D16, 0xE4FF}    01101000 1011 11 10 00000010 00000000 11111111 00100111
Set time         12:00 pm  Standard  ---       {0x307D16, 0x8CFF}    01101000 1011 11 10 00001100 00000000 11111111 00110001
Set time         01:00 pm  Standard  ---       {0xB07D16, 0x4CFF}    01101000 1011 11 10 00001101 00000000 11111111 00110010

Auto clean       12:00 am  Standard  ---       {0x7016, 0xAEFF}      01101000 0000 11 10 00000000 00000000 11111111 01110101
Auto clean       12:00 am  BoostIQ   ---       {0xB016, 0x2EFF}      01101000 0000 11 01 00000000 00000000 11111111 01110100
Auto clean       12:00 am  Max       ---       {0x3016, 0xCEFF}      01101000 0000 11 00 00000000 00000000 11111111 01110011

Up               12:00 am  Standard  ---       {0x7416, 0xA9FF}      01101000 0010 11 10 00000000 00000000 11111111 10010101
Down             12:00 am  Standard  ---       {0x7E16, 0xA7FF}      01101000 0111 11 10 00000000 00000000 11111111 11100101
Left             12:00 am  Standard  ---       {0x7C16, 0xA5FF}      01101000 0011 11 10 00000000 00000000 11111111 10100101
Right            12:00 am  Standard  ---       {0x7616, 0xABFF}      01101000 0110 11 10 00000000 00000000 11111111 11010101

Start            12:00 am  Standard  ---       {0x7A16, 0xA3FF}      01101000 0101 11 10 00000000 00000000 11111111 11000101
Start            12:00 am  BoostIQ   ---       {0xBA16, 0x23FF}      01101000 0101 11 01 00000000 00000000 11111111 11000100
Start            12:00 am  Max       ---       {0x3A16, 0xC3FF}      01101000 0101 11 00 00000000 00000000 11111111 11000011

Stop             12:00 am  ---       ---       {0xF216, 0x6DFF}      01101000 0100 11 11 00000000 00000000 11111111 10110110

Spiral           12:00 am  Max       ---       {0x3116, 0xCFFF}      01101000 1000 11 00 00000000 00000000 11111111 11110011
Edge             12:00 am  Max       ---       {0x3916, 0xC0FF}      01101000 1001 11 00 00000000 00000000 11111111 00000011

Room             12:00 am  Standard  ---       {0x7516, 0xA8FF}      01101000 1010 11 10 00000000 00000000 11111111 00010101
Room             12:00 am  BoostIQ   ---       {0xB516, 0x28FF}      01101000 1010 11 01 00000000 00000000 11111111 00010100
Room             12:00 am  Max       ---       {0x3516, 0xC8FF}      01101000 1010 11 00 00000000 00000000 11111111 00010011

Go home          12:00 am  ---       ---       {0xF716, 0x6AFF}      01101000 1110 11 11 00000000 00000000 11111111 01010110

Set schedule     12:00 am  ---       12:00 am  {0xF316, 0xEC00}      01101000 1100 11 11 00000000 00000000 00000000 00110111
Set schedule     12:00 am  ---       12:15 am  {0xF316, 0x1C80}      01101000 1100 11 11 00000000 00000000 00000001 00111000
Set schedule     12:00 am  ---       12:30 am  {0xF316, 0x9C40}      01101000 1100 11 11 00000000 00000000 00000010 00111001
Set schedule     12:00 am  ---       12:45 am  {0xF316, 0x5CC0}      01101000 1100 11 11 00000000 00000000 00000011 00111010
Set schedule     12:00 am  ---       01:00 am  {0xF316, 0xDC20}      01101000 1100 11 11 00000000 00000000 00000100 00111011
Set schedule     12:00 am  ---       11:45 pm  {0xF316, 0x69FA}      01101000 1100 11 11 00000000 00000000 01011111 10010110
</code></pre></div>

<h4 id="checksum">Checksum</h4>

<p>The final byte of the message is a checksum. By inspection, I determined that it‚Äôs equal to the first 5 bytes added together, with the most significant bit of the result dropped.</p>

<h4 id="other-notes">Other notes</h4>

<ul>
  <li>Obviously, not all possible combinations are represented above.</li>
  <li>The current time and scheduled cleaning time can be included with any other command.</li>
  <li>The current time has minute precision, while a future cleaning can only be scheduled in 15 minute increments. That‚Äôs because there are 2 bytes for setting the time and only 1 for setting a schedule.</li>
  <li>Up, Down, Left, and Right commands can be sent in any fan mode.</li>
  <li>Spiral and Edge cleaning commands are always sent with the fan mode set to Max.</li>
  <li>I didn‚Äôt really need to figure out any of this‚Äì I could have just naively recorded the relevant commands from the remote, but I wanted to understand what they meant. My curiouity was piqued when I noticed that same button triggered a different signal depending what time it was, hinting at the fact made clear above that the current time is encoded in every transmission.</li>
</ul>

<h2 id="homekit">HomeKit</h2>

<p>With the remote signals decoded, the next step was to figure out how to get the ESP32 and HomeKit to play together.</p>

<p><a href="https://en.wikipedia.org/wiki/HomeKit">HomeKit</a> is Apple‚Äôs framework for controlling smart devices. Devices can be controlled by Siri or using Apple‚Äôs <a href="https://www.apple.com/home-app/">Home App</a>. The UI/UX of the app is entirely dictated by Apple, with manufacturers getting no say in how the user interacts with a device. Under the hood, communication between HomeKit and smart devices is based on the <a href="https://developer.apple.com/homekit/specification/">HomeKit Accessory Protocol</a>. HAP‚Äôs model consists of <em>accessories</em> (devices), which implement <em>services</em> (‚ÄúLight Bulb‚Äù, ‚ÄúFan‚Äù, ‚ÄúTemperature Sensor‚Äù, etc.), which possess <em>characteristics</em> (e.g. ‚ÄúBrightness‚Äù, ‚ÄúOn‚Äù, and ‚ÄúCurrentTemperature‚Äù), which have a <em>state</em> (a boolean or an integer, mainly). An accessory may implement multiple services; services, depending on the type, must possess certain characteristics and may possess others. A ‚ÄúLight Bulb‚Äù, for example, must possess an ‚ÄúOn‚Äù characteristic (<em>true</em> or <em>false</em>) but may also include ‚ÄúBrightness‚Äù, or ‚ÄúHue‚Äù, or a couple other optional characteristics; how these characteristics are displayed to the user is up to the Home app.</p>

<p>There‚Äôs an extremely polished HomeKit library for the ESP32 called <a href="https://github.com/HomeSpan/HomeSpan/">HomeSpan</a>, which abstracts away all of the networking details and HAP-related communication,  basically trivializing writing the software for a HomeKit device to 1) describing the accessory/service/characteristic relationships and 2) writing the logic for controlling the physical device. HomeSpan includes an excellent tutorial in the form of 20 progressively more complicated <a href="https://github.com/HomeSpan/HomeSpan/tree/master/examples">examples</a> which walk you through the features of HAP and HomeSpan.</p>

<p>There‚Äôs not much more to say about HomeKit, except that it‚Äôs conspicuously missing a ‚ÄúRobot Vacuum‚Äù service (this is probably a pain in the ass for iRobot‚Äì the company <em>just this year</em> <a href="https://www.prnewswire.com/news-releases/irobot-releases-genius-4-0-home-intelligence-doubles-the-intelligence-for-roomba-i3-and-i3-robot-vacuums-and-more-301504474.html">announced support for Siri shortcuts</a>, which are basically a hackier DIY version of HomeKit). I decided that for the convenience of HomeKit integration, my vacuum could just as well pretend to be a fan, which is technically correct, anyway.</p>

<p>Here‚Äôs the code. Points of interest:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">DEV_Vacuum</code> extends the built-in <code class="language-plaintext highlighter-rouge">Service::Fan</code> class and overrides its <code class="language-plaintext highlighter-rouge">update</code> and <code class="language-plaintext highlighter-rouge">loop</code> methods. <code class="language-plaintext highlighter-rouge">update</code> is called when HomeKit sends a request to update the device state; <code class="language-plaintext highlighter-rouge">loop</code> is called repeatedly and allows the device to do things and communicate state changes back to HomeKit as necessary.</li>
  <li>A reset button clears the ESP32‚Äôs non-volatile storage. This puts the device back into a Wi-Fi access point setup mode in which you can configure Wi-Fi credentials and HomeKit pairing information.</li>
  <li>The ‚ÄúFan‚Äù service has an ‚ÄúActive‚Äù characteristic (on/off) and a ‚ÄúRotationSpeed‚Äù characteristic, for which I‚Äôm mapping 1 to Standard, 2 to BoostIQ, and 3 to Max (BoostIQ is a ‚Äúsmart‚Äù combination of Standard and Max).</li>
  <li>In ‚Äúauto‚Äù mode, the stock vacuum cleans for 100 minutes or until the battery is low, then returns home. I‚Äôve programmed the HomeKit controller to send the vacuum home after 90 minutes, since it doesn‚Äôt have any way to recognize when the vacuum has independently decided it‚Äôs done.</li>
  <li>Each remote signal is sent four times to reduce the chance of any commands being missed (I didn‚Äôt do this originally and had to take the vacuum apart again to upload a fix ü§¶).
    <ul>
      <li>Incidentally, I <a href="https://github.com/Arduino-IRremote/Arduino-IRremote/pull/1028">helped fix a bug</a> in the IR library related to repeating signals.</li>
    </ul>
  </li>
</ul>

<h3 id="homespan_sketchino"><code class="language-plaintext highlighter-rouge">homespan_sketch.ino</code></h3>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-line-table"><tbody><tr id="line-1" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>1</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;HomeSpan.h&gt;</span>
</pre></td></tr><tr id="line-2" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>2</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;nvs_flash.h&gt;</span>
</pre></td></tr><tr id="line-3" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>3</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"dev_vacuum.h"</span>
</pre></td></tr><tr id="line-4" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>4</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-5" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>5</pre></td><td class="rouge-code"><pre><span class="cp">#define STATUS_LED_PIN 2</span>
</pre></td></tr><tr id="line-6" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>6</pre></td><td class="rouge-code"><pre><span class="cp">#define RESET_BUTTON_PIN 13</span>
</pre></td></tr><tr id="line-7" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>7</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-8" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>8</pre></td><td class="rouge-code"><pre><span class="cp">#define STATUS_AUTO_OFF 300</span>
</pre></td></tr><tr id="line-9" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>9</pre></td><td class="rouge-code"><pre><span class="cp">#define AP_AUTO_OFF 300</span>
</pre></td></tr><tr id="line-10" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>10</pre></td><td class="rouge-code"><pre><span class="cp">#define WEBLOG_ENTRIES 25</span>
</pre></td></tr><tr id="line-11" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>11</pre></td><td class="rouge-code"><pre><span class="cp">#define LOG_LEVEL 0</span>
</pre></td></tr><tr id="line-12" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>12</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-13" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>13</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-14" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>14</pre></td><td class="rouge-code"><pre>  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
</pre></td></tr><tr id="line-15" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>15</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-16" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>16</pre></td><td class="rouge-code"><pre>  <span class="n">configureResetButton</span><span class="p">();</span>
</pre></td></tr><tr id="line-17" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>17</pre></td><td class="rouge-code"><pre>  <span class="n">configureHomeSpan</span><span class="p">();</span>
</pre></td></tr><tr id="line-18" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>18</pre></td><td class="rouge-code"><pre><span class="p">}</span>
</pre></td></tr><tr id="line-19" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>19</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-20" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>20</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">loop</span><span class="p">(){</span>
</pre></td></tr><tr id="line-21" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>21</pre></td><td class="rouge-code"><pre>  <span class="n">pollResetButton</span><span class="p">();</span>
</pre></td></tr><tr id="line-22" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>22</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">poll</span><span class="p">();</span>
</pre></td></tr><tr id="line-23" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>23</pre></td><td class="rouge-code"><pre><span class="p">}</span>
</pre></td></tr><tr id="line-24" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>24</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-25" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>25</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">configureHomeSpan</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-26" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>26</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">setStatusPin</span><span class="p">(</span><span class="n">STATUS_LED_PIN</span><span class="p">);</span>
</pre></td></tr><tr id="line-27" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>27</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">setStatusAutoOff</span><span class="p">(</span><span class="n">STATUS_AUTO_OFF</span><span class="p">);</span>
</pre></td></tr><tr id="line-28" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>28</pre></td><td class="rouge-code"><pre>  
</pre></td></tr><tr id="line-29" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>29</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">setControlPin</span><span class="p">(</span><span class="n">RESET_BUTTON_PIN</span><span class="p">);</span>
</pre></td></tr><tr id="line-30" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>30</pre></td><td class="rouge-code"><pre>  
</pre></td></tr><tr id="line-31" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>31</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">enableWebLog</span><span class="p">(</span><span class="n">WEBLOG_ENTRIES</span><span class="p">,</span><span class="s">"pool.ntp.org"</span><span class="p">,</span><span class="s">"UTC"</span><span class="p">,</span><span class="s">"log"</span><span class="p">);</span>
</pre></td></tr><tr id="line-32" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>32</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">setLogLevel</span><span class="p">(</span><span class="n">LOG_LEVEL</span><span class="p">);</span>
</pre></td></tr><tr id="line-33" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>33</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-34" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>34</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">setApSSID</span><span class="p">(</span><span class="s">"RobotVacuum-Setup"</span><span class="p">);</span>
</pre></td></tr><tr id="line-35" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>35</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">setApTimeout</span><span class="p">(</span><span class="n">AP_AUTO_OFF</span><span class="p">);</span>
</pre></td></tr><tr id="line-36" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>36</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">enableAutoStartAP</span><span class="p">();</span>
</pre></td></tr><tr id="line-37" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>37</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-38" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>38</pre></td><td class="rouge-code"><pre>  <span class="n">homeSpan</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">Category</span><span class="o">::</span><span class="n">Fans</span><span class="p">,</span><span class="s">"Robot Vacuum"</span><span class="p">,</span> <span class="s">"RobotVacuum"</span><span class="p">,</span> <span class="s">"RobotVacuum"</span><span class="p">);</span>
</pre></td></tr><tr id="line-39" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>39</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-40" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>40</pre></td><td class="rouge-code"><pre>  <span class="k">new</span> <span class="n">SpanAccessory</span><span class="p">();</span>
</pre></td></tr><tr id="line-41" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>41</pre></td><td class="rouge-code"><pre>  
</pre></td></tr><tr id="line-42" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>42</pre></td><td class="rouge-code"><pre>    <span class="k">new</span> <span class="n">Service</span><span class="o">::</span><span class="n">AccessoryInformation</span><span class="p">();</span>
</pre></td></tr><tr id="line-43" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>43</pre></td><td class="rouge-code"><pre>      <span class="k">new</span> <span class="n">Characteristic</span><span class="o">::</span><span class="n">Identify</span><span class="p">();</span>
</pre></td></tr><tr id="line-44" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>44</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-45" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>45</pre></td><td class="rouge-code"><pre>    <span class="k">new</span> <span class="n">DEV_Vacuum</span><span class="p">();</span>
</pre></td></tr><tr id="line-46" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>46</pre></td><td class="rouge-code"><pre><span class="p">}</span>
</pre></td></tr><tr id="line-47" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>47</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-48" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>48</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">configureResetButton</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-49" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>49</pre></td><td class="rouge-code"><pre>  <span class="n">pinMode</span><span class="p">(</span><span class="n">RESET_BUTTON_PIN</span><span class="p">,</span> <span class="n">INPUT_PULLUP</span><span class="p">);</span>
</pre></td></tr><tr id="line-50" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>50</pre></td><td class="rouge-code"><pre><span class="p">}</span>
</pre></td></tr><tr id="line-51" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>51</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-52" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>52</pre></td><td class="rouge-code"><pre><span class="kt">void</span> <span class="nf">pollResetButton</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-53" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>53</pre></td><td class="rouge-code"><pre>  <span class="k">if</span> <span class="p">(</span><span class="n">digitalRead</span><span class="p">(</span><span class="n">RESET_BUTTON_PIN</span><span class="p">)</span> <span class="o">==</span> <span class="n">LOW</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-54" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>54</pre></td><td class="rouge-code"><pre>    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"</span><span class="se">\n</span><span class="s">*** Clearing non-volatile storage and restarting...</span><span class="se">\n\n</span><span class="s">"</span><span class="p">);</span>
</pre></td></tr><tr id="line-55" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>55</pre></td><td class="rouge-code"><pre>    <span class="n">nvs_flash_erase</span><span class="p">();</span>
</pre></td></tr><tr id="line-56" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>56</pre></td><td class="rouge-code"><pre>    <span class="n">ESP</span><span class="p">.</span><span class="n">restart</span><span class="p">();</span>
</pre></td></tr><tr id="line-57" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>57</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-58" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>58</pre></td><td class="rouge-code"><pre><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="dev_vacuumh"><code class="language-plaintext highlighter-rouge">dev_vacuum.h</code></h3>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-line-table"><tbody><tr id="line-1" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>1</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">"vacuum_remote.h"</span>
</pre></td></tr><tr id="line-2" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>2</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-3" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>3</pre></td><td class="rouge-code"><pre><span class="cp">#define SPEED_STANDARD 1</span>
</pre></td></tr><tr id="line-4" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>4</pre></td><td class="rouge-code"><pre><span class="cp">#define SPEED_BOOSTIQ 2</span>
</pre></td></tr><tr id="line-5" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>5</pre></td><td class="rouge-code"><pre><span class="cp">#define SPEED_MAX 3</span>
</pre></td></tr><tr id="line-6" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>6</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-7" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>7</pre></td><td class="rouge-code"><pre><span class="cp">#define VACUUM_ON true</span>
</pre></td></tr><tr id="line-8" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>8</pre></td><td class="rouge-code"><pre><span class="cp">#define VACUUM_OFF false</span>
</pre></td></tr><tr id="line-9" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>9</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-10" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>10</pre></td><td class="rouge-code"><pre><span class="cp">#define AUTO_VACUUM_DURATION 90*60*1000 // 90 mins; max 100 mins</span>
</pre></td></tr><tr id="line-11" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>11</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-12" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>12</pre></td><td class="rouge-code"><pre><span class="k">struct</span> <span class="nc">DEV_Vacuum</span> <span class="o">:</span> <span class="n">Service</span><span class="o">::</span><span class="n">Fan</span> <span class="p">{</span>
</pre></td></tr><tr id="line-13" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>13</pre></td><td class="rouge-code"><pre>  <span class="n">SpanCharacteristic</span> <span class="o">*</span><span class="n">name</span><span class="p">;</span>
</pre></td></tr><tr id="line-14" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>14</pre></td><td class="rouge-code"><pre>  <span class="n">SpanCharacteristic</span> <span class="o">*</span><span class="n">power</span><span class="p">;</span>
</pre></td></tr><tr id="line-15" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>15</pre></td><td class="rouge-code"><pre>  <span class="n">SpanCharacteristic</span> <span class="o">*</span><span class="n">speed</span><span class="p">;</span>
</pre></td></tr><tr id="line-16" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>16</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-17" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>17</pre></td><td class="rouge-code"><pre>  <span class="n">DEV_Vacuum</span><span class="p">()</span> <span class="o">:</span> <span class="n">Service</span><span class="o">::</span><span class="n">Fan</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-18" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>18</pre></td><td class="rouge-code"><pre>    <span class="n">name</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Characteristic</span><span class="o">::</span><span class="n">Name</span><span class="p">(</span><span class="s">"Robot Vacuum"</span><span class="p">);</span>
</pre></td></tr><tr id="line-19" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>19</pre></td><td class="rouge-code"><pre>    <span class="n">power</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Characteristic</span><span class="o">::</span><span class="n">Active</span><span class="p">();</span>
</pre></td></tr><tr id="line-20" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>20</pre></td><td class="rouge-code"><pre>    <span class="n">speed</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Characteristic</span><span class="o">::</span><span class="n">RotationSpeed</span><span class="p">(</span><span class="n">SPEED_BOOSTIQ</span><span class="p">);</span>
</pre></td></tr><tr id="line-21" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>21</pre></td><td class="rouge-code"><pre>    <span class="n">speed</span><span class="o">-&gt;</span><span class="n">setRange</span><span class="p">(</span><span class="n">SPEED_STANDARD</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">SPEED_MAX</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
</pre></td></tr><tr id="line-22" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>22</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-23" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>23</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-24" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>24</pre></td><td class="rouge-code"><pre>  <span class="kt">uint32_t</span> <span class="n">timerStart</span><span class="p">;</span>
</pre></td></tr><tr id="line-25" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>25</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-26" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>26</pre></td><td class="rouge-code"><pre>  <span class="n">boolean</span> <span class="n">update</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// Called when HomeKit updates the state</span>
</pre></td></tr><tr id="line-27" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>27</pre></td><td class="rouge-code"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">VACUUM_OFF</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Off</span>
</pre></td></tr><tr id="line-28" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>28</pre></td><td class="rouge-code"><pre>      <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">go_home</span><span class="p">);</span>
</pre></td></tr><tr id="line-29" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>29</pre></td><td class="rouge-code"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">VACUUM_ON</span> <span class="o">&amp;&amp;</span> <span class="n">power</span><span class="o">-&gt;</span><span class="n">getVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">VACUUM_OFF</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Off-&gt;On</span>
</pre></td></tr><tr id="line-30" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>30</pre></td><td class="rouge-code"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">SPEED_STANDARD</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-31" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>31</pre></td><td class="rouge-code"><pre>        <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">auto_standard</span><span class="p">);</span>
</pre></td></tr><tr id="line-32" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>32</pre></td><td class="rouge-code"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">SPEED_BOOSTIQ</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-33" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>33</pre></td><td class="rouge-code"><pre>        <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">auto_boostiq</span><span class="p">);</span>
</pre></td></tr><tr id="line-34" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>34</pre></td><td class="rouge-code"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">SPEED_MAX</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-35" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>35</pre></td><td class="rouge-code"><pre>        <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">auto_max</span><span class="p">);</span>
</pre></td></tr><tr id="line-36" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>36</pre></td><td class="rouge-code"><pre>      <span class="p">}</span>
</pre></td></tr><tr id="line-37" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>37</pre></td><td class="rouge-code"><pre>      
</pre></td></tr><tr id="line-38" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>38</pre></td><td class="rouge-code"><pre>      <span class="n">setTimer</span><span class="p">();</span>
</pre></td></tr><tr id="line-39" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>39</pre></td><td class="rouge-code"><pre>    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span> <span class="c1">// Just a speed change</span>
</pre></td></tr><tr id="line-40" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>40</pre></td><td class="rouge-code"><pre>      <span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">SPEED_STANDARD</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-41" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>41</pre></td><td class="rouge-code"><pre>        <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">change_fan_standard</span><span class="p">);</span>
</pre></td></tr><tr id="line-42" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>42</pre></td><td class="rouge-code"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">SPEED_BOOSTIQ</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-43" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>43</pre></td><td class="rouge-code"><pre>        <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">change_fan_boostiq</span><span class="p">);</span>
</pre></td></tr><tr id="line-44" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>44</pre></td><td class="rouge-code"><pre>      <span class="p">}</span> <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">speed</span><span class="o">-&gt;</span><span class="n">getNewVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">SPEED_MAX</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-45" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>45</pre></td><td class="rouge-code"><pre>        <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">change_fan_max</span><span class="p">);</span>
</pre></td></tr><tr id="line-46" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>46</pre></td><td class="rouge-code"><pre>      <span class="p">}</span>
</pre></td></tr><tr id="line-47" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>47</pre></td><td class="rouge-code"><pre>    <span class="p">}</span>
</pre></td></tr><tr id="line-48" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>48</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-49" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>49</pre></td><td class="rouge-code"><pre>    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</pre></td></tr><tr id="line-50" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>50</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-51" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>51</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-52" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>52</pre></td><td class="rouge-code"><pre>  <span class="kt">void</span> <span class="n">loop</span><span class="p">()</span> <span class="p">{</span>    
</pre></td></tr><tr id="line-53" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>53</pre></td><td class="rouge-code"><pre>    <span class="k">if</span> <span class="p">(</span><span class="n">power</span><span class="o">-&gt;</span><span class="n">getVal</span><span class="p">()</span> <span class="o">==</span> <span class="n">VACUUM_ON</span> <span class="o">&amp;&amp;</span> <span class="n">checkTimer</span><span class="p">())</span> <span class="p">{</span>
</pre></td></tr><tr id="line-54" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>54</pre></td><td class="rouge-code"><pre>      <span class="n">power</span><span class="o">-&gt;</span><span class="n">setVal</span><span class="p">(</span><span class="n">VACUUM_OFF</span><span class="p">);</span>
</pre></td></tr><tr id="line-55" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>55</pre></td><td class="rouge-code"><pre>      <span class="n">VacuumRemote</span><span class="o">::</span><span class="n">command_send</span><span class="p">(</span><span class="n">VacuumRemote</span><span class="o">::</span><span class="n">Command</span><span class="o">::</span><span class="n">go_home</span><span class="p">);</span>
</pre></td></tr><tr id="line-56" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>56</pre></td><td class="rouge-code"><pre>    <span class="p">}</span>
</pre></td></tr><tr id="line-57" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>57</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-58" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>58</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-59" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>59</pre></td><td class="rouge-code"><pre><span class="nl">private:</span>
</pre></td></tr><tr id="line-60" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>60</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-61" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>61</pre></td><td class="rouge-code"><pre>  <span class="kt">void</span> <span class="n">setTimer</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-62" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>62</pre></td><td class="rouge-code"><pre>    <span class="n">timerStart</span> <span class="o">=</span> <span class="n">millis</span><span class="p">();</span>
</pre></td></tr><tr id="line-63" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>63</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-64" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>64</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-65" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>65</pre></td><td class="rouge-code"><pre>  <span class="kt">bool</span> <span class="n">checkTimer</span><span class="p">()</span> <span class="p">{</span>
</pre></td></tr><tr id="line-66" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>66</pre></td><td class="rouge-code"><pre>    <span class="k">return</span> <span class="n">millis</span><span class="p">()</span> <span class="o">-</span> <span class="n">timerStart</span> <span class="o">&gt;</span> <span class="n">AUTO_VACUUM_DURATION</span><span class="p">;</span>
</pre></td></tr><tr id="line-67" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>67</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-68" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>68</pre></td><td class="rouge-code"><pre><span class="p">};</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h3 id="vacuum_remoteh"><code class="language-plaintext highlighter-rouge">vacuum_remote.h</code></h3>

<figure class="highlight"><pre><code class="language-c--" data-lang="c++"><table class="rouge-line-table"><tbody><tr id="line-1" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>1</pre></td><td class="rouge-code"><pre><span class="cp">#define IR_SEND_PIN 15</span>
</pre></td></tr><tr id="line-2" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>2</pre></td><td class="rouge-code"><pre><span class="cp">#include</span> <span class="cpf">&lt;IRremote.hpp&gt;</span>
</pre></td></tr><tr id="line-3" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>3</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-4" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>4</pre></td><td class="rouge-code"><pre><span class="k">namespace</span> <span class="n">VacuumRemote</span> <span class="p">{</span>
</pre></td></tr><tr id="line-5" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>5</pre></td><td class="rouge-code"><pre>  <span class="k">struct</span> <span class="nc">CommandType</span> <span class="p">{</span>
</pre></td></tr><tr id="line-6" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>6</pre></td><td class="rouge-code"><pre>    <span class="kt">uint32_t</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</pre></td></tr><tr id="line-7" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>7</pre></td><td class="rouge-code"><pre>    <span class="kt">char</span><span class="o">*</span> <span class="n">name</span><span class="p">;</span>
</pre></td></tr><tr id="line-8" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>8</pre></td><td class="rouge-code"><pre>  <span class="p">};</span>
</pre></td></tr><tr id="line-9" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>9</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-10" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>10</pre></td><td class="rouge-code"><pre>  <span class="k">namespace</span> <span class="n">Command</span> <span class="p">{</span>
</pre></td></tr><tr id="line-11" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>11</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">auto_standard</span>       <span class="o">=</span> <span class="p">{{</span><span class="mh">0x7016</span><span class="p">,</span> <span class="mh">0xAEFF</span><span class="p">},</span> <span class="s">"auto_standard"</span><span class="p">};</span>
</pre></td></tr><tr id="line-12" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>12</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">auto_boostiq</span>        <span class="o">=</span> <span class="p">{{</span><span class="mh">0xB016</span><span class="p">,</span> <span class="mh">0x2EFF</span><span class="p">},</span> <span class="s">"auto_boostiq"</span><span class="p">};</span>
</pre></td></tr><tr id="line-13" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>13</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">auto_max</span>            <span class="o">=</span> <span class="p">{{</span><span class="mh">0x3016</span><span class="p">,</span> <span class="mh">0xCEFF</span><span class="p">},</span> <span class="s">"auto_max"</span><span class="p">};</span>
</pre></td></tr><tr id="line-14" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>14</pre></td><td class="rouge-code"><pre>  
</pre></td></tr><tr id="line-15" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>15</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">change_fan_standard</span> <span class="o">=</span> <span class="p">{{</span><span class="mh">0x7816</span><span class="p">,</span> <span class="mh">0xA1FF</span><span class="p">},</span> <span class="s">"change_fan_standard"</span><span class="p">};</span>
</pre></td></tr><tr id="line-16" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>16</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">change_fan_boostiq</span>  <span class="o">=</span> <span class="p">{{</span><span class="mh">0xB816</span><span class="p">,</span> <span class="mh">0x21FF</span><span class="p">},</span> <span class="s">"change_fan_boostiq"</span><span class="p">};</span>
</pre></td></tr><tr id="line-17" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>17</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">change_fan_max</span>      <span class="o">=</span> <span class="p">{{</span><span class="mh">0x3816</span><span class="p">,</span> <span class="mh">0xC1FF</span><span class="p">},</span> <span class="s">"change_fan_max"</span><span class="p">};</span>
</pre></td></tr><tr id="line-18" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>18</pre></td><td class="rouge-code"><pre>    
</pre></td></tr><tr id="line-19" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>19</pre></td><td class="rouge-code"><pre>    <span class="n">CommandType</span> <span class="n">go_home</span>             <span class="o">=</span> <span class="p">{{</span><span class="mh">0xF716</span><span class="p">,</span> <span class="mh">0x6AFF</span><span class="p">},</span> <span class="s">"go_home"</span><span class="p">};</span>
</pre></td></tr><tr id="line-20" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>20</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-21" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>21</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-22" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>22</pre></td><td class="rouge-code"><pre>  <span class="kt">void</span> <span class="n">command_send</span><span class="p">(</span><span class="n">CommandType</span> <span class="o">&amp;</span><span class="n">command</span><span class="p">)</span> <span class="p">{</span>
</pre></td></tr><tr id="line-23" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>23</pre></td><td class="rouge-code"><pre>    <span class="n">WEBLOG</span><span class="p">(</span><span class="s">"Sending remote command: %s"</span><span class="p">,</span> <span class="n">command</span><span class="p">.</span><span class="n">name</span><span class="p">);</span>
</pre></td></tr><tr id="line-24" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>24</pre></td><td class="rouge-code"><pre>
</pre></td></tr><tr id="line-25" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>25</pre></td><td class="rouge-code"><pre>    <span class="n">IrSender</span><span class="p">.</span><span class="n">sendPulseDistanceWidthFromArray</span><span class="p">(</span>
</pre></td></tr><tr id="line-26" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>26</pre></td><td class="rouge-code"><pre>      <span class="mi">38</span><span class="p">,</span>           <span class="c1">// uint_fast8_t aFrequencyKHz</span>
</pre></td></tr><tr id="line-27" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>27</pre></td><td class="rouge-code"><pre>      <span class="mi">3050</span><span class="p">,</span>         <span class="c1">// unsigned int aHeaderMarkMicros</span>
</pre></td></tr><tr id="line-28" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>28</pre></td><td class="rouge-code"><pre>      <span class="mi">2950</span><span class="p">,</span>         <span class="c1">// unsigned int aHeaderSpaceMicros</span>
</pre></td></tr><tr id="line-29" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>29</pre></td><td class="rouge-code"><pre>      <span class="mi">550</span><span class="p">,</span>          <span class="c1">// unsigned int aOneMarkMicros</span>
</pre></td></tr><tr id="line-30" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>30</pre></td><td class="rouge-code"><pre>      <span class="mi">1500</span><span class="p">,</span>         <span class="c1">// unsigned int aOneSpaceMicros</span>
</pre></td></tr><tr id="line-31" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>31</pre></td><td class="rouge-code"><pre>      <span class="mi">550</span><span class="p">,</span>          <span class="c1">// unsigned int aZeroMarkMicros</span>
</pre></td></tr><tr id="line-32" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>32</pre></td><td class="rouge-code"><pre>      <span class="mi">500</span><span class="p">,</span>          <span class="c1">// unsigned int aZeroSpaceMicros</span>
</pre></td></tr><tr id="line-33" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>33</pre></td><td class="rouge-code"><pre>      <span class="n">command</span><span class="p">.</span><span class="n">data</span><span class="p">,</span> <span class="c1">// uint32_t[] aDecodedRawDataArray</span>
</pre></td></tr><tr id="line-34" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>34</pre></td><td class="rouge-code"><pre>      <span class="mi">48</span><span class="p">,</span>           <span class="c1">// unsigned int aNumberOfBits</span>
</pre></td></tr><tr id="line-35" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>35</pre></td><td class="rouge-code"><pre>      <span class="nb">false</span><span class="p">,</span>        <span class="c1">// bool aMSBFirst</span>
</pre></td></tr><tr id="line-36" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>36</pre></td><td class="rouge-code"><pre>      <span class="c1">//true,         // bool aSendStopBit; only exists in main, not release</span>
</pre></td></tr><tr id="line-37" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>37</pre></td><td class="rouge-code"><pre>      <span class="mi">100</span><span class="p">,</span>          <span class="c1">// unsigned int aRepeatPeriodMillis</span>
</pre></td></tr><tr id="line-38" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>38</pre></td><td class="rouge-code"><pre>      <span class="mi">3</span>             <span class="c1">// int_fast8_t aNumberOfRepeats</span>
</pre></td></tr><tr id="line-39" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>39</pre></td><td class="rouge-code"><pre>    <span class="p">);</span>
</pre></td></tr><tr id="line-40" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>40</pre></td><td class="rouge-code"><pre>  <span class="p">}</span>
</pre></td></tr><tr id="line-41" class="lineno"><td class="rouge-gutter gl" style="-moz-user-select: none;-ms-user-select: none;-webkit-user-select: none;user-select: none;"><pre>41</pre></td><td class="rouge-code"><pre><span class="p">}</span>
</pre></td></tr></tbody></table></code></pre></figure>

<h2 id="vacuum-surgery">Vacuum Surgery</h2>

<p>The final step was implanting the new Wi-Fi brain into the 11S. Disassembling the vacuum was extremely straightforward‚Äì it was obviously designed with repairability in mind. Luckily for me, despite the ‚ÄòS‚Äô in 11S standing for ‚Äúslim‚Äù, they didn‚Äôt squeeze out all the air, either. One corner of the shell, near the power switch, has a big empty space perfectly sized to accomodate my ESP32 board and a voltage regulator.</p>

<p><img src="/assets/images/blog/2022-10-04/empty_space.jpg" class="medium" /></p>

<p>I went back and forth a bit on how to power the ESP32. The ESP32 runs on 3.3 V; the dev board includes a linear regulator to accomodate 4.75 V - 12 V input (so it can be powered by USB). The vacuum‚Äôs battery, consisting of four 18650 cells<sup>‚Ä†</sup>, has a nominal voltage of 14.4 V (real voltage: 16.4 V). The vacuum‚Äôs logic board seems to run mostly on 3.3 V, but I measured 5 V across some sensors, and, although I didn‚Äôt test them, I assume the motors run on the full battery voltage. I considered powering the ESP32 straight from the logic board‚Äôs 3.3 V circuitry, but since the ESP can draw &gt; 150 mA when using Wi-Fi and I had no idea what tolerences were built in to the 11S main board, rather than risk melting/enflaming anything, I opted to wire in a <a href="https://www.amazon.ca/Zixtec-Converter-Voltage-Regulator-3-0-40V/dp/B07VVXF7YX">buck converter</a> directly to the battery and power switch to drop the 16.4 V battery voltage down to 3.3 V (buck converters are semiconductor-based and vastly more efficient than linear regulators, which downshift voltage by dissipating extra power as heat).</p>

<p><sup>‚Ä†</sup><em>18650s are truly the modern AA. They power Teslas, e-cigarettes, flashlights, laptops, portable power banks, e-bikes, Bluetooth speakers, robo vacuums‚Ä¶</em></p>

<p><img src="/assets/images/blog/2022-10-04/like_a_glove.jpg" class="medium" /></p>

<p>I mentioned a reset button earlier‚Äì if I have to change my Wi-Fi SSID or password, I don‚Äôt want to have to disassemble the vacuum to access the ESP32‚Äôs USB serial interface. I left a long wire connected to the button input and drew it out into the battery compartment, which is easily accessible from the outside. Touching the wire to the negative contact on the battery completes the button circuit and tells the ESP32 to clear its non-volatile storage (I left a note to remind my future self how this works).</p>

<p><img src="/assets/images/blog/2022-10-04/note_to_self.jpg" class="small" /></p>

<p>Putting it all together, we get this:</p>

<ul>
  <li>Buck converter wired in to the battery‚Äôs negative lead and the hard power switch.</li>
  <li>ESP32 powered from the buck converter.</li>
  <li>Infrared LED connected to the ESP32 and pointed directly at one of the vacuum‚Äôs several IR receivers.</li>
  <li>Reset wire tucked into the battery compartment.</li>
</ul>

<p>Ta-da! I can now control the vacuum with Siri (‚ÄúHey Siri, turn on/off the vacuum‚Äù), manually in the Home app, or with HomeKit automations (e.g. ‚Äúwhenever everybody is out of the the house while the sun is up, turn on the vacuum for 30 minutes‚Äù). üéâ</p>

<p><img src="/assets/images/blog/2022-10-04/home_app.png" class="tiny" /></p>

</section>

    </div>

    <div id="default-footer">
      
      <footer>
        <div><small>Copyright &copy; 2022 Stephen Humphries</small></div>
        <div><small>PGP: 6CF3&nbsp;3595&nbsp;1E54&nbsp;1ED2&nbsp;3C66&nbsp;1444&nbsp;CEDA&nbsp;0AA8&nbsp;3DE2&nbsp;A2CB</small></div>
      </footer>
      
    </div>
  </div>
</body>

</html>
